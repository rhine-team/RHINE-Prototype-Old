# sign

## Name

*sign* - adds RHINE records to zone files.

## Description
This is a modified *sign* plugin, it is used to sign zones. In this process Rhine resource records are
added. The signatures that sign the resource records sets have an expiration date, this means the
signing process must be repeated before this expiration data is reached.  The *sign* plugin takes care of this.


*Sign* works in conjunction with the *file* and *auto* plugins; this plugin **signs** the zones
files, *auto* and *file* **serve** the zones *data*.

For this plugin to work at least one Common Signing Key, and one RCert/private key pair generated by rhine offline protocol is needed. 
The signing key (or keys) will be used to sign the entire zone(regular resource records), the private key paired with RCert will be used to sign
the signing key(ZSK), and *sign* plugin will add RCert as a TXT record to zone files. *Sign* does *not* support the ZSK/KSK split, nor will
it do key or algorithm rollovers - it just signs.

*Sign* will:


 * Create RRSIGs that have an inception of -3 hours (minus a jitter between 0 and 18 hours)
    and a expiration of +32 (plus a jitter between 0 and 5 days) days for every given DNSKEY.

 * Create RRSIG signed with private key paired with RCert for the zone signing key

 * Create a TXT record encoding RCert

 * Update the SOA's serial number to the *Unix epoch* of when the signing happens. This will
    overwrite *any* previous serial number.


There are two ways that dictate when a zone is signed. Normally every 6 days (plus jitter) it will
be resigned. If for some reason we fail this check, the 14 days before expiring kicks in.

Keys are named (following BIND9): `K<name>+<alg>+<id>.key` and `K<name>+<alg>+<id>.private`.
The keys **must not** be included in your zone; they will be added by *sign*. These keys can be
generated with `coredns-keygen` or BIND9's `dnssec-keygen`. You don't have to adhere to this naming
scheme, but then you need to name your keys explicitly, see the `keys file` directive.

The RCert and pairing private key file should suffix with `_private.pem` and `_cert.pem`, for e.g. `example.org_private.pem` 
and `example.org_cert.pem`.
A generated zone is written out in a file named `db.<name>.signed` in the directory named by the
`directory` directive (which defaults to `/var/lib/coredns`).

## Syntax

~~~
sign DBFILE [ZONES...] {
    rcert file RCERT...
    key file|directory KEY...|DIR...
    directory DIR
}
~~~

* **DBFILE** the zone database file to read and parse. If the path is relative, the path from the
   *root* plugin will be prepended to it.
* **ZONES** zones it should be sign for. If empty, the zones from the configuration block are
   used.
* `rcert` specifies the filename for rcert and it's pairing private key to sign the zone. 
* `key` specifies the key(s) (there can be multiple) to sign the zone. If `file` is
   used the **KEY**'s filenames are used as is. If `directory` is used, *sign* will look in **DIR**
   for `K<name>+<alg>+<id>` files. Any metadata in these files (Activate, Publish, etc.) is
   *ignored*. These keys must also be Key Signing Keys (KSK).
* `directory` specifies the **DIR** where CoreDNS should save zones that have been signed.
   If not given this defaults to `/var/lib/coredns`. The zones are saved under the name
   `db.<name>.signed`. If the path is relative the path from the *root* plugin will be prepended
   to it.

Keys can be generated with `coredns-keygen`, to create one for use in the *sign* plugin, use:
`coredns-keygen example.org` or `dnssec-keygen -a ECDSAP256SHA256 -f KSK example.org`.

RCert and it's corresponding private key should be generated by RHINE offline protocol.
## Examples

Sign the `example.org` zone contained in the file `db.example.org` and write the result to
`./db.example.org.signed` to let the *file* plugin pick it up and serve it. The keys used
are read from `/etc/coredns/keys/Kexample.org.key` and `/etc/coredns/keys/Kexample.org.private`.
The rcert and its private key used are read from `/etc/rhine/rcert/example.org_cert.pem` and
`/etc/rhine/rcert/example.org_private.pem`
~~~ txt
example.org {
    file db.example.org.signed

    sign db.example.org {
        rcert file /etc/rhine/rcert/example.org
        key file /etc/coredns/keys/Kexample.org
        directory .
    }
}
~~~

Running this leads to the following log output (note the timers in this example have been set to
shorter intervals).

~~~ txt
[WARNING] plugin/file: Failed to open "open /tmp/db.example.org.signed: no such file or directory": trying again in 1m0s
[INFO] plugin/sign: Signing "example.org." because open /tmp/db.example.org.signed: no such file or directory
[INFO] plugin/sign: Successfully signed zone "example.org." in "/tmp/db.example.org.signed" with key tags "59725" and 1564766865 SOA serial, elapsed 9.357933ms, next: 2019-08-02T22:27:45.270Z
[INFO] plugin/file: Successfully reloaded zone "example.org." in "/tmp/db.example.org.signed" with serial 1564766865
~~~


## Bugs

`keys directory` is not implemented.
